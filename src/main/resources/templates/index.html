<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
	<title>DedupEndNote</title>

	<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
	<script th:src="@{/webjars/jquery-ui/jquery-ui.min.js}"></script>
	<script th:src="@{/webjars/blueimp-file-upload/js/jquery.fileupload.js}"></script>
	<script th:src="@{/webjars/blueimp-file-upload/js/jquery.fileupload-process.js}"></script>
	<link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
	<script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}" type="text/javascript"></script>
	<script th:src="@{/webjars/sockjs-client/dist/sockjs.min.js}"></script>
	<script th:src="@{/webjars/stomp-websocket/stomp.min.js}"></script>
	<link rel="stylesheet" href="/resources/common-style.css">

	<script th:inline="javascript">
		var stompClient = null;
		var wssessionId = null;

		/* Also adds data to the start form (step 2) */
		function checkFileSize(evant, data) {
			if (data.files[0].size > (150 * 1024 * 1024)) {
				var MB = parseInt(data.files[0].size / (1024 * 1024));
				alert("File is bigger than 150 MB! This file: " + MB + "MB");
			} else {
				// connect();
				$("#fileName_1").val(data.files[0].name);
				data.submit();
			}
		}

		function hideDiv(id) {
			$(id).removeClass('d-block');
			$(id).addClass('d-none');
		}
		function showDiv(id) {
			$(id).removeClass('d-none');
			$(id).addClass('d-block');
		}
		function showProgress(percentage) {
			$("#progress").html(`<div class="progress-bar" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage}%</div>`);
		}
		function disableButton(id) {
			$(id).prop("disabled", true);
		}
		function enableButton(id) {
			$(id).prop("disabled", false);
		}
		function markAsDone(id) {
			$(id).removeClass('alert-warning');
			$(id).addClass('alert-success');
		}
		/*
		 * Calling disconnect() will invalidate the wssessionId?
		 * Would it be better to restart with a reload?
		 * - new wssessionId
		 * - if there is a old running deduplication, then its messages will be send to the subscription which is no longer valid,
		 *   and not interfere with the current subscription 
		 */
		function disconnect() {
			if (stompClient !== null) {
			}
			console.log("Disconnected");
		}

		$(function () {

			connect();

			function connect() {
				var socket = new SockJS('/gs-guide-websocket');
				stompClient = Stomp.over(socket);
				stompClient.debug = null;	// disable debug, shorthand for: "stompClient.debug = function(str) {};" see https://stomp-js.github.io/stomp-websocket/codo/class/Client.html 
				stompClient.connect({}, function (frame) {
					// subscribe to a user specific URL (see the controller for more info)
					var wssessionId = /\/([^\/]+)\/websocket/.exec(socket._transport.url)[1];
					// console.log("connected, session id: " + wssessionId);
					$("#wssessionId").val(wssessionId);
					stompClient.subscribe('/topic/messages-' + wssessionId, function (stompMessage) {
						let message = JSON.parse(stompMessage.body).name
						if (message.match("^DONE")) {
							showProgress(0);
							$('#results').html(message);
							enableButton('#buttonResultFile');
							markAsDone('#step2');
						} else if (message.match("^ERROR")) {
							$('#results').removeClass('alert-warning');
							$('#results').addClass('alert-danger');
							$('#results').html(message);
						} else if (message.match("^PROGRESS:")) {
							var found = message.match(/^PROGRESS: (.+)$/);
							var percentage = found[1];
							showProgress(percentage);
						} else {
							console.log("DATA: " + message);
							$('#results').html("<span>" + message + "</span>");
						}
					});
				});
			}

			$('#file').change(function () {
				// solution for "fakepath" problem: remove everything before the fileName
				var fileName = $("#file").val();
				var myRegex = /^(.+\\)([^\\]+)$/;
				var match = myRegex.exec(fileName);
				if (match != null) {
					fileName = match[2];
				}
				$("#fileName_1").val(fileName);
			});

			$('#upload_form').fileupload({
				dataType: 'json',
				limitMultiFileUploads: 1,
				replaceFileInput: false,
				start: function () {
					showProgress(0);
				},
				add: function (event, data) {
					checkFileSize(event, data);
				},
				done: function (e, data) {
					$("#markModeResultFile").val($("input[name='markMode']").prop("checked"));
					if (data.textStatus == "success") {
						showProgress(0);
						$('#results').html("<span>File " + data.files[0].name + " has been uploaded</span>");
						disableButton('#fileUpload1');
						enableButton('#buttonStartDeduplication');
						markAsDone('#step1');
					}
				},
				error: function (jqXHR, data, thrownError) {
					var response = jQuery.parseJSON(jqXHR.responseText);
					$('#results').html("<span>" + response.result + "</span>");
					$('#results').addClass('alert-danger');
					$('#results').removeClass('alert-warning');
				},
				progressall: function (e, data) {
					var percentage = parseInt(data.loaded / data.total * 100, 10);
					$("#progress").html(`<div class="progress-bar" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage}%</div>`);
				}
			});

			$('#buttonStartDeduplication').on('click', function (event) {
				event.preventDefault();
				disableButton('#buttonStartDeduplication');
				$("#fileNameResultFile").val($('#fileName_1').val());	// in getResultFile_form
				$("#markModeResultFile").val($('#markMode').prop("checked"));	// in getResultFile_form

				$.ajax({
					url: '/startOneFile',
					type: 'POST',
					data: new FormData(document.getElementById('start_form')),
					dataType: 'json',
					processData: false,
					contentType: false,
					success: function (response) {
						console.log("RESPONSE: " + response.result);
						if (response.result.match("^DONE")) {
							$('#results').html(response.result);
						} else if (response.result.match("^ERROR")) {
							$('#results').removeClass('alert-warning');
							$('#results').addClass('alert-danger');
							$('#results').html(response.result);
						} else {
							$('#results').html(response.result);
						}
					}
				});
			});

		});
	</script>
	<style>
		#steps h3 {
			margin-top: 0px;
		}
	</style>
</head>

<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-3">
				<nav id="menu" class="navbar navbar-light bg-light" style="position: fixed;">
					<div class="container-fluid">
						<div class="navbar-nav" id="navmenu">
							<nav class="nav nav-pills flex-column small">
								<a class="nav-link" href="#start">Top</a>
								<a class="nav-link" href="#introduction">Introduction</a>
								<a class="nav-link" href="#steps" target="_self">Steps</a>
								<!-- <a class="nav-link" href="#why">Why DedupEndNote?</a> -->
								<a class="nav-link" href="#how">How it works</a>
								<a class="nav-link" href="#output">Output</a>
								<a class="nav-link" href="#markModeText">Mark mode</a>
								<!-- <a class="nav-link" href="#performance">Performance</a> -->
								<a class="nav-link" href="#citing">How to cite</a>
								<a class="nav-link" href="#issues">Issues and feature requests</a>
								<a class="nav-link external-link" href="/changelog" target="window2">Changelog</a>
								<a class="nav-link external-link" href="/details" target="window2">Details, lots of
									details ...</a>
							</nav>
						</div>
					</div>
				</nav>
			</div>
			<div class="col-7" data-bs-spy="scroll" data-bs-target="#navmenu">
				<h1 id="start">DedupEndNote (version 1.1.0 2025-10-08)</h1>
				<div class="row border border-primary rounded alert alert-secondary" id="step1">
					<div class="col-3">
						<h4>1. INPUT FILE</h4>
					</div>
					<div class="col-9">
						<form class="form-horizontal" id="upload_form" method="post" enctype="multipart/form-data"
							th:action="@{|/uploadFile|}">
							<div class="input-group">
								<label for="oldFile" class="form-label">Select the EndNote / Zotero RIS file to
									deduplicate<br />(use <a class="link-underline-light" href="/twofiles">Deduplicate 2
										files</a> to deduplicate an new set of records against an old set)</label><br />
								<input type="file" id="fileUpload1" name="file" />
							</div>
						</form>
					</div>
				</div>
				<div class="row border border-primary rounded alert alert-secondary" id="step2">
					<div class="col-3">
						<h4>2. START</h4>
					</div>
					<div class="col-9">
						<form class="form-horizontal" id="start_form" method="post" action="">
							<input type="hidden" id="fileName_1" name="fileName_1" value="" />
							<input type="hidden" id="wssessionId" name="wssessionId" value="" />
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="checkbox" id="markMode" name="markMode" />
								<label class="form-check-label" for="file"> Do NOT deduplicate the file but mark the
									duplicate records (see <a class="link-underline-light" href="#markModeText">Mark
										mode</a>)</label>
							</div>
							<div>
								<button type="submit" id="buttonStartDeduplication" disabled
									class="btn btn-primary mb-2">Start deduplication</button>
							</div>
						</form>
					</div>
				</div>
				<div class="row border border-primary rounded alert alert-secondary" id="step3">
					<div class="col-3">
						<h4>3. RESULT</h4>
					</div>
					<div class="col-9">
						<form class="form-horizontal" id="getResultFile_form" method="post"
							th:action="@{|/getResultFile|}">
							<input type="hidden" name="fileNameResultFile" id="fileNameResultFile" />
							<input type="hidden" name="markModeResultFile" id="markModeResultFile" />
							<!-- nodig om submit() voor IE te laten werken -->
							<button type="submit" id="buttonResultFile" disabled class="btn btn-primary mb-2"
								onclick="this.form.submit(); markAsDone('#step3');">Get the result</button>
						</form>
					</div>
				</div>
				<div class="row" style="margin-top: 10px;">
					<div class="col-10 border border-primary rounded">
						<h4>Progress</h4>
						<div id="progress" class="progress" style="height: 20px;">
							<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
								aria-valuemax="100"></div>
						</div>
						<p id="results" class="alert alert-warning">Waiting for new input file ...</p>
					</div>
					<div class="col-1"></div>
					<div class="col-1">
						<a class="btn btn-primary" href="/" role="button">Restart</a>
					</div>
				</div>

				<div style="margin-top: 30px;">
					<h3 id="introduction">Introduction</h3>
					<p><b>DedupEndNote</b> is a tool for removing duplicate records from EndNote or Zotero databases
						exported in <b>RIS format</b>.
						It is more flexible than the built in deduplication features in EndNote or Zotero,
						and identifies a lot more duplicates that those programs.</p>
					<p>You can:</p>
					<ul>
						<li>Deduplicate a single file (this page)</li>
						<li>Compare a new file against an existing file (see <a class="link-underline-light"
								href="/twofiles">Deduplicate 2 files</a>)</li>
					</ul>

					<p>The program has been tested on EndNote and Zotero databases with records from:
						CINAHL (EBSCOHost), Cochrane Library, EMBASE (OVID and Embase.com), Medline (OVID), PsycINFO
						(OVID), PubMed, Scopus, Web of Science (very few tests with conference papers).</p>

					<h2 id="steps">Steps</h2>
					<p>Deduplicate one file:</p>
					<ul>
						<li>Export an EndNote / Zotero database into a file in RIS format</li>
						<li>Upload this file in DedupEndNote</li>
						<li>Save the results file with deduplicated records</li>
						<li>Import this results file into a <b>new</b> EndNote / Zotero database</li>
					</ul>
					<p>Deduplicate a new file against an existing file / EndNote database: see <a
							class="link-underline-light" href="/twofiles">Deduplicate 2
							files</a></p>

					<!--
					<h3>Why Use DedupEndNote?</h3>
					<ul>
						<li><b>Higher detection rate</b> – EndNote and Zotero often miss duplicates, even with a
							maintained Journals List.</li>
						<li><b>More forgiving matching</b> – DedupEndNote tolerates small differences in metadata that
							would
							cause other tools to miss a match.</li>
						<li><b>Works across sources</b> – Useful for PubMed, Cochrane, Web of Science, and other
							databases that
							lack robust deduplication.</li>
					</ul>
				-->

					<div class="alert alert-warning" role="alert">
						The page <a class="link-underline-light" href="/details" target="window2">Details, lots of
							details ...</a> has a lot more detailed information on the following subjects.
					</div>

					<div class="d-flex justify-content-between">
						<span class="h3" id="how">How it works</span>
					</div>
					<p>DedupEndNote compares each pair of records in up to five stages, stopping early if a mismatch is
						found:</p>
					<ol>
						<li><b>Publication Year</b>: Matches if the years are the same or differ by at most one year.
						</li>
						<li><b>Starting Page or DOI</b>: Compares page numbers and DOIs with preprocessing to handle
							variations.</li>
						<li><b>Authors</b>: Uses Jaro-Winkler similarity on up to the first 40 authors, with name
							normalization.</li>
						<li><b>Title</b>: Compares normalized or reversed titles.</li>
						<li><b>ISBN / ISSN / Journal</b>: Matches exact ISBNs or ISSNs or compares normalized journal
							titles.</li>
					</ol>
					<p>If a pair scores YES in all applicable comparisons, they are considered duplicates.</p>

					<h3 id="output">Output</h3>
					<p>By default, only the first record in each duplicate set is kept. The output file:</p>
					<ul>
						<li>Preserves all unique records</li>
						<li>Enriches them with missing data from duplicates (e.g., DOI, journal name, publication year,
							pages)</li>
						<li>Normalizes certain fields (e.g., DOI format, page ranges)</li>
					</ul>

					<h3 id="markModeText">Mark mode</h3>
					<p>Instead of removing duplicates, Mark Mode labels them for manual review:</p>
					<ul>
						<li>The ID of the first record in each duplicate set is copied to the <b>Label (LB)</b> field of
							all duplicates.</li>
						<li>The original Label content is overwritten.</li>
						<li>No enrichment or normalization is performed.</li>
					</ul>
					<p>This mode is useful if you want to merge records manually in EndNote.</p>

					<!-- <h3 id="performance">Performance</h3>
					<ul>
						<li>DedupEndNote is slower than EndNote/Zotero because it performs more detailed comparisons.
						</li>
						<li>Example: Deduplicating a 115 MB RIS file (~15,000 records) takes ~20 seconds.</li>
					</ul> -->

					<h3 id="citing">How to cite</h3>
					<p>If you use DedupEndNote, please cite:</p>
					<p>Lobbestael, G. (2025). DedupEndNote (Version 1.1.0) [Computer software].
						https://github.com/globbestael/DedupEndNote</p>

					<h3 id="issues">Issues and feature requests</h3>
					<div>If you have any questions about the tool or come across a problem when trying to use it,
						please raise an issue on the <a class="link-underline-light"
							href="https://github.com/globbestael/DedupEndNote" target="github">GitHub Repository</a>.
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>